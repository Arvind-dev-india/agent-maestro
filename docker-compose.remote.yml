# Docker Compose file for running pre-built Agent Maestro image on remote VM
# This file uses the published Docker image instead of building locally

services:
  agent-maestro-demo:
    # Use pre-built image from Docker Hub (replace with your actual image name)
    image: yourusername/agent-maestro-tailscale:latest

    container_name: agent-maestro-demo
    hostname: agent-maestro-${USER:-demo}

    environment:
      # Tailscale configuration (REQUIRED)
      - TAILSCALE_AUTH_KEY=${TAILSCALE_AUTH_KEY}
      - TAILSCALE_HOSTNAME=agent-maestro-${USER:-demo}

      # VS Code API connection (REQUIRED - update with your VS Code host)
      # If VS Code is on a different machine, replace with that machine's IP or hostname
      - LOCAL_VSCODE_HOST=${VSCODE_HOST:-host.docker.internal}
      - LOCAL_VSCODE_PORT=${VSCODE_PORT:-23333}
      - API_BASE_URL=http://${VSCODE_HOST:-host.docker.internal}:${VSCODE_PORT:-23333}/api/v1

      # Demo site configuration
      - NODE_ENV=production

      # Security and performance (optional, defaults shown)
      - SESSION_TIMEOUT=${SESSION_TIMEOUT:-3600000}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-900000}
      - API_TIMEOUT=${API_TIMEOUT:-30000}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}

      # Feature flags (optional, defaults shown)
      - ENABLE_LOGGING=${ENABLE_LOGGING:-true}
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}

    ports:
      # Optional: expose demo site on host (if needed for local access)
      - "${DEMO_PORT:-3000}:3000"

    # Allow access to host network for VS Code extension
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Required for Tailscale
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - "/dev/net/tun:/dev/net/tun"

    volumes:
      - tailscale-data:/var/lib/tailscale
      - /lib/modules:/lib/modules:ro

    restart: unless-stopped

    # Security settings
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"

volumes:
  tailscale-data:
    driver: local
